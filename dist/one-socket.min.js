!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).OneSocket=t()}(this,function(){"use strict";function i(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}if(!WebSocket)throw new Error("WebSocket is not exist");function o(){for(var e=[],t="0123456789abcdef",a=0;a<36;a++)e[a]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}return function(){function e(a){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"ws",null),s(this,"promiseCallback",[]),s(this,"dataQueue",[]),s(this,"watchEventList",{}),s(this,"sendStatus",!1),s(this,"timeoutTimer",null),s(this,"bindEvent",function(t){var e=r.promiseCallback,a=e.resolve,n=e.reject;r.ws.addEventListener("open",function(){clearTimeout(r.timeoutTimer),a&&(a(!0),r.promiseCallback={},t.defaultOption.hasHeartbeat&&r.heartbeat(t))}),r.ws.addEventListener("close",function(e){clearTimeout(r.timeoutTimer),clearTimeout(t.timer),clearTimeout(t.heartbeatTimer),console.warn("socket has closed"),t.defaultOption.onClose(e)}),r.ws.addEventListener("error",function(t){n?(n(!1),r.promiseCallback={}):r.watchEventList.error.forEach(function(e){e(t)})}),r.ws.addEventListener("message",function(e){t.defaultOption.responseParser(e,r.messageHouse,t)})}),s(this,"messageHouse",function(t,e,a,n){var i,s=null,r=e.service;(s="exact"===n.defaultOption.mode?e.id:e.service)&&(n.callbackMap[s]||n.watchEventList[r])&&((n.watchEventList[r]||[]).forEach(function(e){e(t)}),n.callbackMap[s]&&(i=n.callbackMap[s].shift(),n.callbackMap[s].length||(n.callbackMap[s]=void 0),a?i?i[0](t):console.error("".concat(s,"'s callback is undefined")):i?i[1](t):console.error("".concat(s,"'s callback is undefined"))))}),s(this,"queueSend",function(e,t){r.dataQueue.push(e),!r.sendStatus&&r.dataQueue.length&&r.sendData(t)}),s(this,"sendData",function(t){r.sendStatus=!0,clearTimeout(t.heartbeatTimer),t.timer=setTimeout(function(){var e;r.ws.readyState===WebSocket.OPEN?(e=r.dataQueue.shift(),r.ws.send(e),t.defaultOption.hasHeartbeat&&r.heartbeat(t),r.dataQueue.length?r.sendData(t):r.sendStatus=!1):r.ws.readyState===WebSocket.CONNECTING&&r.sendData(t)},t.defaultOption.interval)}),s(this,"heartbeat",function(e){var t=e.defaultOption,a=t.heartbeatPack,n=t.heartbeatInterval;e.heartbeatTimer=setTimeout(function(){r.ws.send(JSON.stringify(Object.assign({},a,{id:o()}))),r.heartbeat(e)},n)}),s(this,"init",function(){var t=r.promiseCallback.reject;try{r.ws=new WebSocket(r.defaultOption.url),r.ws.timeoutInterval=r.defaultOption.timeout,r.timeoutTimer=setTimeout(function(){r.ws.close(),r.timeoutTimer=null},r.defaultOption.timeout)}catch(e){t(e)}}),s(this,"send",function(a,n){var i=o(),s=r.defaultOption.mode;return"exact"===s&&(a=i),new Promise(function(e,t){this.callbackMap[a]?this.callbackMap[a].push([e,t]):this.callbackMap[a]=[[e,t]],"exact"===s&&(n=Object.assign({},n,{id:i})),this.queueSend(JSON.stringify(n),this)}.bind(r))}),s(this,"close",function(){clearTimeout(r.timer),clearTimeout(r.heartbeatTimer),r.ws.close()}),s(this,"then",function(t){return r.__Promise__.then(function(e){return t(this)}.bind(r))}),s(this,"catch",function(t){return r.__Promise__.catch(function(e){return t(e)})}),this.defaultOption={url:"",mode:"vague",timeout:2e3,interval:50,hasHeartbeat:!0,heartbeatInterval:1e4,instance:null,heartbeatPack:{lang:"zh_cn",service:"ping",token:""},responseParser:function(e,t,a){var n=JSON.parse(e.data),i=n.result_data;t(i,{service:i.service},1===n.result_code,a)},onClose:function(){}},this.callbackMap={},this.defaultOption=Object.assign({},this.defaultOption,a),this.heartbeatTimer=null;var n=this.defaultOption.instance;this.__Promise__=new Promise(function(e,t){this.promiseCallback={resolve:e,reject:t},n?this.ws=n:this.init(a),this.bindEvent(this)}.bind(this))}var t,a,n;return t=e,(a=[{key:"on",value:function(e,t){this.watchEventList[e]?this.watchEventList[e].push(t):this.watchEventList[e]=[t]}},{key:"remove",value:function(e,t){var a=this.watchEventList[e].findIndex(function(e){return e===t});this.watchEventList.splice(a,1)}},{key:"destroy",value:function(e){delete this.watchEventList[e]}},{key:"updateConfig",value:function(e){var t=e.heartbeatPack;this.defaultOption.heartbeatPack=t}}])&&i(t.prototype,a),n&&i(t,n),e}()});
