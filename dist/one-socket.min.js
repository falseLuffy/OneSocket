!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).OneSocket=t()}(this,function(){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}if(!WebSocket)throw new Error("WebSocket is not exist");var r=null,o=[],s=[],u=[],c={},l=!1,f=function(t){var e=o.resolve,n=o.reject;r.addEventListener("open",function(){e&&(e(!0),o={},t.defaultOption.hasHeartbeat&&d(t))}),r.addEventListener("close",function(e){clearTimeout(t.timer),clearTimeout(t.heartbeatTimer),console.warn("socket has closed"),t.defaultOption.onClose(e)}),r.addEventListener("error",function(t){n?(n(!1),o={}):c.error.forEach(function(e){e(t)})}),r.addEventListener("message",function(e){t.defaultOption.responseParser(e,a,t)})},a=function(t,e,n,a){var i,r=null,o=e.service;!(r="exact"===a.defaultOption.mode?e.id:e.service)||u.indexOf(r)<0&&!c[o]||((c[o]||[]).forEach(function(e){e(t)}),a.callbackMap[r]&&(i=a.callbackMap[r].shift(),a.callbackMap[r].length||(a.callbackMap[r]=void 0),n?i?i[0](t):console.error("".concat(r,"'s callback is undefined")):i?i[1](t):console.error("".concat(r,"'s callback is undefined"))))},h=function t(n){l=!0,clearTimeout(n.heartbeatTimer),n.timer=setTimeout(function(){var e;r.readyState===WebSocket.OPEN?(e=s.shift(),r.send(e),n.defaultOption.hasHeartbeat&&d(n),s.length?t(n):l=!1):r.readyState===WebSocket.CONNECTING&&0===r.reconnectAttempts&&t(n)},n.defaultOption.interval)},d=function e(t){var n=t.defaultOption,a=n.heartbeatPack,i=n.heartbeatInterval;t.heartbeatTimer=setTimeout(function(){r.send(JSON.stringify(Object.assign({},a,{id:b()}))),e(t)},i)};function b(){for(var e=[],t="0123456789abcdef",n=0;n<36;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}return function(){function e(n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.defaultOption={url:"",mode:"vague",timeout:13e3,interval:50,hasHeartbeat:!0,heartbeatInterval:1e4,instance:null,heartbeatPack:{lang:"zh_cn",service:"ping",token:""},responseParser:function(e,t,n){var a=JSON.parse(e.data),i=a.result_data;t(i,{service:i.service},1===a.result_code,n)},onClose:function(){}},this.callbackMap={},this.defaultOption=Object.assign({},this.defaultOption,n),this.heartbeatTimer=null;var a=this.defaultOption.instance;this.__Promise__=new Promise(function(e,t){o={resolve:e,reject:t},a?r=a:this.init(n),f(this)}.bind(this))}var t,n,a;return t=e,(n=[{key:"init",value:function(){var t=o.reject;try{(r=new WebSocket(this.defaultOption.url)).timeoutInterval=this.defaultOption.timeout}catch(e){t(e)}}},{key:"send",value:function(i,r){var o=b(),c=this.defaultOption.mode;return"exact"===c&&(i=o),u.push(i),new Promise(function(e,t){var n,a;this.callbackMap[i]?this.callbackMap[i].push([e,t]):this.callbackMap[i]=[[e,t]],"exact"===c&&(r=Object.assign({},r,{id:o})),n=JSON.stringify(r),a=this,s.push(n),!l&&s.length&&h(a)}.bind(this))}},{key:"close",value:function(){clearTimeout(this.timer),clearTimeout(this.heartbeatTimer),r.close()}},{key:"then",value:function(t){return this.__Promise__.then(function(e){return t(this)}.bind(this))}},{key:"catch",value:function(t){return this.__Promise__.catch(function(e){return t(e)})}},{key:"on",value:function(e,t){c[e]?c[e].push(t):c[e]=[t]}},{key:"remove",value:function(e,t){var n=c[e].findIndex(function(e){return e===t});c.splice(n,1)}},{key:"destroy",value:function(e){delete c[e]}},{key:"updateConfig",value:function(e){var t=e.heartbeatPack;this.defaultOption.heartbeatPack=t}}])&&i(t.prototype,n),a&&i(t,a),e}()});
