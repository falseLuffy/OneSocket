!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).OneSocket=t()}(this,function(){"use strict";if(!WebSocket)throw new Error("WebSocket is not exist");var r=null,i=[],c=[],u=[],s=[],l=!1;function e(n){this.defaultOption={url:"",mode:"vague",timeout:13e3,interval:50,hasHeartbeat:!0,heartbeatInterval:1e4,heartbeatPack:{lang:"zh_cn",service:"ping",token:""},responseParser:function(e,t,n){var i=JSON.parse(e.data),o=i.result_data;t(o,{service:o.service},1===i.result_code,n)},onClose:function(){}},this.callbackMap={},this.defaultOption=Object.assign({},this.defaultOption,n),this.heartbeatTimer=null,this.__Promise__=new Promise(function(e,t){i={resolve:e,reject:t},this.init(n),o(this)}.bind(this))}e.prototype.init=function(){var t=i.reject;try{(r=new WebSocket(this.defaultOption.url)).timeoutInterval=this.defaultOption.timeout}catch(e){t(e)}};var o=function(t){var e=i.resolve,n=i.reject;r.addEventListener("open",function(){e&&(e(!0),i={},t.defaultOption.hasHeartbeat&&d(t))}),r.addEventListener("close",function(e){clearTimeout(t.timer),clearTimeout(t.heartbeatTimer),console.warn("socket has closed"),t.defaultOption.onClose(e)}),r.addEventListener("error",function(t){n?(n(!1),i={}):s.error.forEach(function(e){e(t)})}),r.onmessage=function(e){t.defaultOption.responseParser(e,a,t)}},a=function(t,e,n,i){var o,r=null,a=null,a=(r="exact"===i.defaultOption.mode?e.id:e.service,e.service);!r||u.indexOf(r)<0&&!s[a]?console.warn(r+" is not a defined service"):((s[a]||[]).forEach(function(e){e(t)}),i.callbackMap[r]&&(o=i.callbackMap[r].shift(),n?o?o[0](t):console.error("callback is undefined"):o?o[1](t):console.error("callback is undefined")))},f=function t(n){l=!0,clearTimeout(n.heartbeatTimer),n.timer=setTimeout(function(){var e=c.shift();r.send(e),n.defaultOption.hasHeartbeat&&d(n),c.length?t(n):l=!1},n.defaultOption.interval)},d=function e(t){var n=t.defaultOption,i=n.heartbeatPack,o=n.heartbeatInterval;t.heartbeatTimer=setTimeout(function(){r.send(JSON.stringify(Object.assign({},i,{id:h()}))),e(t)},o)};function h(){for(var e=[],t="0123456789abcdef",n=0;n<36;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}return e.prototype.send=function(o,r){var a=h(),s=this.defaultOption.mode;return"exact"===s&&(o=a),u.push(o),new Promise(function(e,t){var n,i;this.callbackMap[o]?this.callbackMap[o].push([e,t]):this.callbackMap[o]=[[e,t]],"exact"===s&&(r=Object.assign({},r,{id:a})),n=JSON.stringify(r),i=this,c.push(n),l||f(i)}.bind(this))},e.prototype.close=function(){clearTimeout(this.timer),clearTimeout(this.heartbeatTimer),r.close()},e.prototype.then=function(t){return this.__Promise__.then(function(e){return t(this)}.bind(this))},e.prototype.catch=function(t){return this.__Promise__.catch(function(e){return t(e)})},e.prototype.on=function(e,t){s[e]?s[e].push(t):s[e]=[t]},e.prototype.remove=function(e,t){var n=s[e].findIndex(function(e){return e===t});s.splice(n,1)},e.prototype.destory=function(e){delete s[e]},e.prototype.updateConfig=function(e){var t=e.heartbeatPack;this.defaultOption.heartbeatPack=t},e});
